import { useEffect, useState, useContext, useCallback } from 'react';
import { useSearchParams } from 'react-router-dom';
import { LatLng, Map } from 'leaflet';
import { Box, Button, Grid } from '@mui/material';
import { AddCircle } from '@mui/icons-material';
import { useRpcClient } from '@/hooks/useRpcClient';
import { useSimulation } from '@/hooks/useSimulation';
import { useVehicleData } from '@/hooks/useVehicleData';
import { useEntitlements } from '@/hooks/useEntitlements';
import { PageTitle } from '@/components/PageTitle';
import { CopMap } from '@/components/Map/CopMap';
import { BannerContext } from '@/contexts/BannerContext';
import { SrcType } from '@/proto/tdf_object/v1/tdf_object_pb';
import { VehicleData } from '@/types/vehicle';
import { VehiclePopOutResponse } from '@/components/Map/Vehicle';
import { SourceTypeProvider } from './SourceTypeProvider';
import { CreateDialog } from './CreateDialog';
import { SourceTypeSelector } from './SourceTypeSelector';
import { SearchFilter } from './SearchFilter';
import { SearchResults } from './SearchResults';
import { SimulationPanel } from './SimulationPanel';
import { VehicleDetailSidebar } from './VehicleDetailSidebar';

export function SourceTypes() {
  const [searchParams, setSearchParams] = useSearchParams();
  const [srcTypeId, setSrcTypeId] = useState<string | null>(null);
  const [selectable, setSelectable] = useState<boolean | null>();
  const [map, setMap] = useState<Map | null>(null);
  const [dialogOpen, setDialogOpen] = useState(false);
  const [srcType, setSrcType] = useState<SrcType>();
  const [poppedOutVehicle, setPoppedOutVehicle] = useState<VehiclePopOutResponse | null>(null);

  const { getSrcType } = useRpcClient();
  const { tdfObjects, setTdfObjects, activeEntitlements } = useContext(BannerContext);
  const { categorizedData } = useEntitlements();
  const { filteredVehicleData, vehicleSrcType, fetchVehicles } = useVehicleData();

  const fetchSrcType = useCallback(async (id: string) => {
    try {
      const { srcType } = await getSrcType({ srcType: id });
      setSrcType(srcType);
    } catch (err) {
      console.warn(`'${id}' is not a valid source type.`);
      setSrcType(undefined);
      setSearchParams(new URLSearchParams());
    }
  }, [getSrcType, setSearchParams]);

  const handleSrcTypeIdChange = useCallback((id: string) => {
    const newSearchParams = new URLSearchParams(searchParams);
    newSearchParams.set('type', id);
    if (id !== srcTypeId) {
      newSearchParams.delete('q');
    }
    setSearchParams(newSearchParams);
  }, [searchParams, srcTypeId, setSearchParams]);

  const handleDialogOpen = () => {
    const newSearchParams = new URLSearchParams(searchParams);
    newSearchParams.set('mode', 'create');
    setSearchParams(newSearchParams);
    setDialogOpen(true);
  };

  const handleDialogClose = () => {
    const newSearchParams = new URLSearchParams(searchParams);
    newSearchParams.delete('mode');
    setSearchParams(newSearchParams);
    setDialogOpen(false);
  };

  const handleFlyToClick = useCallback(({ lat, lng }: LatLng) => {
    if (map) map.flyTo({ lat, lng }, map.getZoom());
  }, [map]);

  const handleVehicleClick = useCallback((vehicle: VehicleData) => {
    console.log('Selected vehicle:', vehicle);
  }, []);

  const handlePopOut = useCallback((response: VehiclePopOutResponse) => {
    setPoppedOutVehicle(response);
  }, []);

  const simulation = useSimulation({
    onStartSuccess: fetchVehicles,
  });

  // Close sidebar when classification level changes to prevent showing data above current clearance
  useEffect(() => {
    if (poppedOutVehicle) {
      setPoppedOutVehicle(null);
    }
  }, [activeEntitlements]);

  useEffect(() => {
    const type = searchParams.get('type');
    const select = searchParams.get('select');
    const mode = searchParams.get('mode');

    setSelectable(select !== 'false');

    if (!type) {
      setSrcType(undefined);
      setSrcTypeId(null);
      return;
    }

    if (type !== srcTypeId) {
      setSrcTypeId(type);
      setTdfObjects([]);
      fetchSrcType(type);
    }

    if (mode === 'create') {
      setDialogOpen(true);
    }
  }, [searchParams, fetchSrcType, srcTypeId, setTdfObjects]);

  const searchResultsTdfObjects = srcTypeId === 'vehicles'
  ? [] // If the selected type is 'vehicles', show an empty list in SearchResults.
  : tdfObjects; // Otherwise, show the actual tdfObjects (from BannerContext).

  return (
    <>
      <PageTitle
        title="Source Types"
        subContent={selectable ? <SourceTypeSelector value={srcTypeId} onChange={handleSrcTypeIdChange} /> : null} />
      <SourceTypeProvider srcType={srcType}>
        <Grid container spacing={3}>
          <Grid item xs={12} md={7}>
            <CopMap
              filteredVehicleData={filteredVehicleData}
              tdfObjects={tdfObjects}
              activeEntitlements={activeEntitlements}
              onMapReady={setMap}
              onVehicleClick={handleVehicleClick}
              onPopOut={handlePopOut}
            />
          </Grid>
          <Grid item xs={12} md={5}>
            <SimulationPanel
              isStarting={simulation.isStarting}
              isStopping={simulation.isStopping}
              isRunning={simulation.isRunning}
              logs={simulation.logs}
              onStart={simulation.start}
              onStop={simulation.stop}
              onClearLogs={simulation.clearLogs}
            />

            <Box display="flex" gap={1} mb={2}>
              <SearchFilter map={map} />
              <Button variant="contained" color="primary" onClick={handleDialogOpen} startIcon={<AddCircle />}>New</Button>
            </Box>
            <SearchResults tdfObjects={searchResultsTdfObjects} onFlyToClick={handleFlyToClick} />
          </Grid>
        </Grid>
        <CreateDialog open={dialogOpen} onClose={handleDialogClose} />
        {poppedOutVehicle && (
          <VehicleDetailSidebar
            vehicle={poppedOutVehicle}
            vehicleSrcType={vehicleSrcType}
            categorizedData={categorizedData || {}}
            onClose={() => setPoppedOutVehicle(null)}
            onFlyToClick={handleFlyToClick}
          />
        )}
      </SourceTypeProvider>
    </>
  );
}